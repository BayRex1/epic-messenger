const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const { Pool } = require('pg');

const app = express();
const server = http.createServer(app);

const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: {
    rejectUnauthorized: false
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function initDatabase() {
  try {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...');
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    await pool.query(`
      CREATE TABLE IF NOT EXISTS users (
        id VARCHAR(50) PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        username VARCHAR(50) UNIQUE NOT NULL,
        display_name VARCHAR(100) NOT NULL,
        password VARCHAR(255) NOT NULL,
        status VARCHAR(20) DEFAULT 'online',
        verified BOOLEAN DEFAULT false,
        is_developer BOOLEAN DEFAULT false,
        avatar TEXT,
        description TEXT DEFAULT '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Epic Messenger',
        coins INTEGER DEFAULT 1000,
        gifts JSONB DEFAULT '[]',
        used_promocodes JSONB DEFAULT '[]',
        created_at TIMESTAMP DEFAULT NOW(),
        deleted BOOLEAN DEFAULT false
      )
    `);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–æ–æ–±—â–µ–Ω–∏–π
    await pool.query(`
      CREATE TABLE IF NOT EXISTS messages (
        id VARCHAR(50) PRIMARY KEY,
        user_id VARCHAR(50) REFERENCES users(id),
        username VARCHAR(50) NOT NULL,
        display_name VARCHAR(100) NOT NULL,
        text TEXT NOT NULL,
        to_user_id VARCHAR(50) REFERENCES users(id),
        timestamp TIMESTAMP DEFAULT NOW(),
        verified BOOLEAN DEFAULT false,
        is_developer BOOLEAN DEFAULT false,
        type VARCHAR(20) DEFAULT 'text',
        file_data TEXT,
        file_name VARCHAR(255),
        file_type VARCHAR(50),
        file_size INTEGER DEFAULT 0,
        gift_id VARCHAR(50),
        gift_name VARCHAR(255),
        gift_price INTEGER,
        deleted BOOLEAN DEFAULT false
      )
    `);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å—Ç–æ–≤
    await pool.query(`
      CREATE TABLE IF NOT EXISTS posts (
        id VARCHAR(50) PRIMARY KEY,
        user_id VARCHAR(50) REFERENCES users(id),
        text TEXT NOT NULL,
        image TEXT,
        likes JSONB DEFAULT '[]',
        comments JSONB DEFAULT '[]',
        timestamp TIMESTAMP DEFAULT NOW()
      )
    `);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–¥–∞—Ä–∫–æ–≤
    await pool.query(`
      CREATE TABLE IF NOT EXISTS gifts (
        id VARCHAR(50) PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        price INTEGER NOT NULL,
        image TEXT,
        type VARCHAR(20) NOT NULL,
        created_by VARCHAR(50) REFERENCES users(id),
        created_at TIMESTAMP DEFAULT NOW(),
        deleted BOOLEAN DEFAULT false
      )
    `);

    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    await pool.query(`
      CREATE TABLE IF NOT EXISTS promocodes (
        id VARCHAR(50) PRIMARY KEY,
        code VARCHAR(100) UNIQUE NOT NULL,
        coins INTEGER NOT NULL,
        max_uses INTEGER DEFAULT 1,
        used_count INTEGER DEFAULT 0,
        used_by JSONB DEFAULT '[]',
        created_by VARCHAR(50) REFERENCES users(id),
        created_at TIMESTAMP DEFAULT NOW(),
        deleted BOOLEAN DEFAULT false
      )
    `);

    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–æ–¥–∞—Ä–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    const giftsCount = await pool.query('SELECT COUNT(*) FROM gifts WHERE deleted = false');
    if (parseInt(giftsCount.rows[0].count) === 0) {
      await pool.query(`
        INSERT INTO gifts (id, name, price, image, type, created_by, created_at) VALUES
        ('1', '–ó–æ–ª–æ—Ç–∞—è –∫–æ—Ä–æ–Ω–∞', 100, null, 'image', 'system', NOW()),
        ('2', '–ê–Ω–∏–º–∞—Ü–∏—è —Å —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–æ–º', 50, null, 'gif', 'system', NOW())
      `);
    }

    console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:', error);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
initDatabase();

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));
app.use(express.static(__dirname));

const onlineUsers = new Map();

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// –ë–∞–∑–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'index.html'));
});

app.get('/main.html', (req, res) => {
  res.sendFile(path.join(__dirname, 'main.html'));
});

app.get('/login.html', (req, res) => {
  res.sendFile(path.join(__dirname, 'login.html'));
});

// Health check –¥–ª—è Render.com
app.get('/health', async (req, res) => {
  try {
    const usersCount = await pool.query('SELECT COUNT(*) FROM users WHERE deleted = false');
    const messagesCount = await pool.query('SELECT COUNT(*) FROM messages WHERE deleted = false');
    const postsCount = await pool.query('SELECT COUNT(*) FROM posts');
    const giftsCount = await pool.query('SELECT COUNT(*) FROM gifts WHERE deleted = false');
    const promocodesCount = await pool.query('SELECT COUNT(*) FROM promocodes WHERE deleted = false');
    
    res.json({ 
      status: 'OK', 
      timestamp: new Date().toISOString(),
      users: parseInt(usersCount.rows[0].count),
      messages: parseInt(messagesCount.rows[0].count),
      posts: parseInt(postsCount.rows[0].count),
      gifts: parseInt(giftsCount.rows[0].count),
      promocodes: parseInt(promocodesCount.rows[0].count),
      storage: 'PostgreSQL'
    });
  } catch (error) {
    res.status(500).json({ status: 'ERROR', error: error.message });
  }
});

// API routes
app.post('/api/register', async (req, res) => {
  try {
    const { email, username, displayName, password } = req.body;
    
    if (!email || !username || !displayName || !password) {
      return res.json({ success: false, message: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π username (case insensitive)
    const existingUser = await pool.query(
      'SELECT * FROM users WHERE LOWER(username) = LOWER($1) AND deleted = false',
      [username]
    );
    
    if (existingUser.rows.length > 0) {
      return res.json({ success: false, message: '–Æ–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π email
    const existingEmail = await pool.query(
      'SELECT * FROM users WHERE email = $1 AND deleted = false',
      [email]
    );
    
    if (existingEmail.rows.length > 0) {
      return res.json({ success: false, message: 'Email —É–∂–µ –∑–∞–Ω—è—Ç' });
    }
    
    const userId = Date.now().toString();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–∞–µ–º –ø—Ä–∞–≤–∞ –µ—Å–ª–∏ username BayRex (case insensitive)
    const isBayRex = username.toLowerCase() === 'bayrex';
    
    const newUser = {
      id: userId,
      email,
      username,
      display_name: displayName,
      password: password,
      verified: isBayRex,
      is_developer: isBayRex,
      coins: 1000,
      gifts: [],
      used_promocodes: []
    };
    
    await pool.query(
      `INSERT INTO users (id, email, username, display_name, password, verified, is_developer, coins, gifts, used_promocodes) 
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
      [newUser.id, newUser.email, newUser.username, newUser.display_name, newUser.password, 
       newUser.verified, newUser.is_developer, newUser.coins, JSON.stringify(newUser.gifts), 
       JSON.stringify(newUser.used_promocodes)]
    );
    
    res.json({ 
      success: true, 
      message: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 
      user: {
        id: newUser.id,
        email: newUser.email,
        username: newUser.username,
        displayName: newUser.display_name,
        verified: newUser.verified,
        isDeveloper: newUser.is_developer,
        coins: newUser.coins,
        gifts: newUser.gifts,
        usedPromocodes: newUser.used_promocodes,
        status: 'online',
        avatar: null,
        description: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Epic Messenger',
        createdAt: new Date().toISOString()
      }
    });
  } catch (error) {
    console.error('Error in register:', error);
    res.json({ success: false, message: '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' });
  }
});

app.post('/api/login', async (req, res) => {
  try {
    const { email, password } = req.body;
    
    const user = await pool.query(
      `SELECT * FROM users WHERE 
       (email = $1 OR LOWER(username) = LOWER($1)) AND 
       password = $2 AND deleted = false`,
      [email, password]
    );
    
    if (user.rows.length === 0) {
      return res.json({ success: false, message: '–ù–µ–≤–µ—Ä–Ω—ã–π email/—é–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ –ø–∞—Ä–æ–ª—å' });
    }
    
    const userData = user.rows[0];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ–Ω–ª–∞–π–Ω
    await pool.query(
      'UPDATE users SET status = $1 WHERE id = $2',
      ['online', userData.id]
    );
    
    res.json({ 
      success: true, 
      message: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 
      user: {
        id: userData.id,
        email: userData.email,
        username: userData.username,
        displayName: userData.display_name,
        status: 'online',
        verified: userData.verified,
        isDeveloper: userData.is_developer,
        avatar: userData.avatar,
        description: userData.description,
        coins: userData.coins,
        gifts: userData.gifts || [],
        usedPromocodes: userData.used_promocodes || [],
        createdAt: userData.created_at
      }
    });
  } catch (error) {
    console.error('Error in login:', error);
    res.json({ success: false, message: '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞' });
  }
});

// –û—Å—Ç–∞–ª—å–Ω—ã–µ API endpoints –Ω—É–∂–Ω–æ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –¥–ª—è PostgreSQL
// –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–∫–∞–∂—É –æ—Å–Ω–æ–≤–Ω—ã–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–µ–ª–∞—é—Ç—Å—è –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏:

app.get('/api/users', async (req, res) => {
  try {
    const { currentUserId } = req.query;
    const users = await pool.query(
      'SELECT * FROM users WHERE id != $1 AND deleted = false',
      [currentUserId]
    );
    
    const usersFormatted = users.rows.map(user => ({
      id: user.id,
      email: user.email,
      username: user.username,
      displayName: user.display_name,
      status: user.status,
      verified: user.verified,
      isDeveloper: user.is_developer,
      avatar: user.avatar,
      description: user.description,
      coins: user.coins,
      gifts: user.gifts || [],
      usedPromocodes: user.used_promocodes || [],
      createdAt: user.created_at
    }));
    
    res.json(usersFormatted);
  } catch (error) {
    console.error('Error getting users:', error);
    res.json([]);
  }
});

app.get('/api/messages/:userId/:targetId', async (req, res) => {
  try {
    const { userId, targetId } = req.params;
    
    const messages = await pool.query(
      `SELECT * FROM messages WHERE 
       ((user_id = $1 AND to_user_id = $2) OR (user_id = $2 AND to_user_id = $1)) 
       AND deleted = false ORDER BY timestamp ASC`,
      [userId, targetId]
    );
    
    res.json(messages.rows);
  } catch (error) {
    console.error('Error getting messages:', error);
    res.json([]);
  }
});

// WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
io.on('connection', (socket) => {
  console.log('‚úÖ User connected:', socket.id);

  socket.on('user_join', async (userData) => {
    try {
      const user = await pool.query(
        'SELECT * FROM users WHERE id = $1 AND deleted = false',
        [userData.userId]
      );
      
      if (user.rows.length === 0) {
        console.log('‚ùå User not found:', userData.userId);
        socket.emit('user_not_found', { message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        return;
      }
      
      const userRow = user.rows[0];
      
      await pool.query(
        'UPDATE users SET status = $1 WHERE id = $2',
        ['online', userData.userId]
      );
      
      const onlineUser = {
        socketId: socket.id,
        username: userRow.username,
        displayName: userRow.display_name,
        userId: userData.userId,
        status: 'online',
        verified: userRow.verified,
        isDeveloper: userRow.is_developer,
        avatar: userRow.avatar
      };
      
      onlineUsers.set(socket.id, onlineUser);
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ –Ω–æ–≤–æ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      socket.broadcast.emit('user_online', onlineUser);
      
      console.log('üëã User joined:', userRow.display_name);
    } catch (error) {
      console.error('Error in user_join:', error);
    }
  });

  socket.on('load_chat_history', async (data) => {
    try {
      const messages = await pool.query(
        `SELECT * FROM messages WHERE 
         ((user_id = $1 AND to_user_id = $2) OR (user_id = $2 AND to_user_id = $1)) 
         AND deleted = false ORDER BY timestamp ASC`,
        [data.userId, data.targetId]
      );
      
      socket.emit('chat_history_loaded', { 
        targetId: data.targetId, 
        messages: messages.rows 
      });
    } catch (error) {
      console.error('Error loading chat history:', error);
      socket.emit('chat_history_loaded', { 
        targetId: data.targetId, 
        messages: [] 
      });
    }
  });

  socket.on('send_message', async (messageData) => {
    try {
      const onlineUser = onlineUsers.get(socket.id);
      if (!onlineUser) {
        console.log('‚ùå Online user not found for socket:', socket.id);
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∏ –Ω–µ —É–¥–∞–ª–µ–Ω –ª–∏ –æ–Ω
      const recipient = await pool.query(
        'SELECT * FROM users WHERE id = $1 AND deleted = false',
        [messageData.toUserId]
      );
      
      if (recipient.rows.length === 0) {
        socket.emit('user_not_found', { message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –±—ã–ª —É–¥–∞–ª–µ–Ω' });
        return;
      }
      
      const messageId = Date.now().toString();
      
      await pool.query(
        `INSERT INTO messages (id, user_id, username, display_name, text, to_user_id, 
         verified, is_developer, type, file_data, file_name, file_type, file_size, 
         gift_id, gift_name, gift_price) 
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)`,
        [messageId, onlineUser.userId, onlineUser.username, onlineUser.displayName, 
         messageData.text, messageData.toUserId, onlineUser.verified, onlineUser.isDeveloper,
         messageData.type || 'text', messageData.fileData || null, messageData.fileName || null,
         messageData.fileType || null, messageData.fileSize || 0, messageData.giftId || null,
         messageData.giftName || null, messageData.giftPrice || null]
      );
      
      const message = {
        id: messageId,
        userId: onlineUser.userId,
        username: onlineUser.username,
        displayName: onlineUser.displayName,
        text: messageData.text,
        toUserId: messageData.toUserId,
        timestamp: new Date().toISOString(),
        verified: onlineUser.verified,
        isDeveloper: onlineUser.isDeveloper,
        type: messageData.type || 'text',
        fileData: messageData.fileData || null,
        fileName: messageData.fileName || null,
        fileType: messageData.fileType || null,
        fileSize: messageData.fileSize || 0,
        giftId: messageData.giftId || null,
        giftName: messageData.giftName || null,
        giftPrice: messageData.giftPrice || null,
        deleted: false
      };
      
      console.log('üí¨ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç', message.displayName, '–∫', messageData.toUserId);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
      socket.emit('new_message', message);
      socket.emit('message_sent', { success: true });
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é –µ—Å–ª–∏ –æ–Ω –æ–Ω–ª–∞–π–Ω
      const recipientEntry = Array.from(onlineUsers.entries())
        .find(([_, u]) => u.userId === messageData.toUserId);
      
      if (recipientEntry) {
        const [recipientSocketId, recipientUser] = recipientEntry;
        io.to(recipientSocketId).emit('new_message', message);
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é
        io.to(recipientSocketId).emit('new_message_notification', {
          from: onlineUser.displayName,
          message: messageData.text,
          userId: onlineUser.userId
        });
        console.log('üì® –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', recipientUser.displayName);
      }
    } catch (error) {
      console.error('Error sending message:', error);
      socket.emit('message_sent', { success: false, error: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è' });
    }
  });

  socket.on('disconnect', async () => {
    const onlineUser = onlineUsers.get(socket.id);
    if (onlineUser) {
      try {
        await pool.query(
          'UPDATE users SET status = $1 WHERE id = $2',
          ['offline', onlineUser.userId]
        );
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –æ –≤—ã—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        socket.broadcast.emit('user_offline', onlineUser);
        
        onlineUsers.delete(socket.id);
        
        console.log('üëã User disconnected:', onlineUser.displayName);
      } catch (error) {
        console.error('Error updating user status on disconnect:', error);
      }
    }
  });
});

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 3000;

server.listen(PORT, '0.0.0.0', () => {
  console.log('=====================================');
  console.log('üöÄ EPIC MESSENGER SERVER STARTED!');
  console.log('üì° Port:', PORT);
  console.log('üåê Environment:', process.env.NODE_ENV || 'development');
  console.log('üíæ Storage: PostgreSQL');
  console.log('üîê Authentication: ENABLED');
  console.log('‚úÖ Verified system: ACTIVE');
  console.log('üë®‚Äçüíª Developer badges: ENABLED');
  console.log('üñºÔ∏è Avatar upload: ENABLED');
  console.log('üìÅ File sharing: ENABLED');
  console.log('üîç User search: ENABLED');
  console.log('üìù Posts system: ENABLED');
  console.log('üéÅ Gift shop: ENABLED');
  console.log('üí∞ Promocodes system: ENABLED');
  console.log('üóëÔ∏è Message deletion: ENABLED');
  console.log('üõ°Ô∏è BayRex account: PROTECTED FROM DELETION');
  console.log('üì± Mobile version: FIXED KEYBOARD ISSUES');
  console.log('=====================================');
});
